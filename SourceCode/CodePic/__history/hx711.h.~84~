#ifndef HX711_H
#define HX711_H

// HX711 Pin Definitions
#define HX711_DT_PIN PIN_A0
#define HX711_SCK_PIN PIN_A1

// Global variables for offset and scale
long OFFSET = 0;
// Ð?t SCALE v? 1.0. Giá tr? này s? du?c tính toán l?i b?i hx711_calibrate()
double SCALE = 1.0; 

// Ngu?ng nhi?u cho giá tr? RAW
// Gi?m ngu?ng nhi?u d? gi? l?i d? nh?y t?t hon
#define HX711_RAW_NOISE_THRESHOLD 100 

// Function to read raw data from HX711
unsigned int32 readCount(void) {
   unsigned int32 data = 0;
   unsigned int8 j;

   // Ð?m b?o SCK ? m?c th?p tru?c khi b?t d?u d?c
   output_bit(HX711_SCK_PIN, 0); 

   // Ch? HX711 s?n sàng (DT ? m?c th?p)
   while (input(HX711_DT_PIN));

   // Ð?c 24 bit d? li?u
   for (j = 0; j < 24; j++) {
      output_bit(HX711_SCK_PIN, 1); // Kéo SCK lên cao
      delay_us(1); // Thêm d? tr? nh? d? d?m b?o xung nh?p d? r?ng
      data = data << 1;             // D?ch bit d? li?u sang trái
      output_bit(HX711_SCK_PIN, 0); // Kéo SCK xu?ng th?p
      delay_us(1); // Thêm d? tr? nh?
      if (input(HX711_DT_PIN)) {    // Ð?c bit d? li?u
         data++;
      }
   }

   // T?o xung nh?p 25 (ho?c 26/27) d? ch?n kênh A/d? l?i (gain)
   output_bit(HX711_SCK_PIN, 1);
   delay_us(1); // Thêm d? tr? nh?
   data = data ^ 0x800000; // Chuy?n d?i t? bù 2 sang s? nguyên có d?u
   output_bit(HX711_SCK_PIN, 0);
   delay_us(1); // Thêm d? tr? nh?

   return data;
}

// Function to read average raw value
int32 readAverage(void) {
   unsigned int32 sum = 0;
   int8 k; 

   for (k = 0; k < 30; k++) { 
      sum += readCount();
      delay_us(50); // Tang d? tr? gi?a các l?n d?c d? d?m b?o ?n d?nh
   }
   return sum / 30;
}

// Function to get value (raw - offset)
long hx711_get_value(int8 times) {
   long raw_value = readAverage();
   long delta = raw_value - OFFSET;
   
   // Áp d?ng ngu?ng nhi?u chính xác hon: ch? d?t v? 0 n?u giá tr? n?m trong d?i ch?t.
   if (delta < HX711_RAW_NOISE_THRESHOLD && delta > -HX711_RAW_NOISE_THRESHOLD) {
       delta = 0; 
   }
   return delta;
}

// Function to get weight in grams
float hx711_get_units(int8 times) {
   float value = (float)hx711_get_value(times);
   
   // Chia cho SCALE d? chuy?n d?i sang don v? gram.
   // Ð?m b?o SCALE không b?ng 0 d? tránh l?i chia cho 0.
   if (SCALE == 0) return 0; 
   value = value / SCALE;

   // Tránh hi?n th? giá tr? âm nh? ho?c giá tr? duong r?t nh? do nhi?u khi không có v?t
   // ho?c khi v?t du?c nh?c ra kh?i cân.
   if (value < 0.5 && value > -0.5) return 0; // Làm tròn v? 0 n?u trong kho?ng ±0.5g
   
   return value;
}

// Function to tare (set current weight as zero)
void hx711_tare(int8 times) {
   OFFSET = readAverage(); 
}

// Function to set the scale factor manually
void hx711_set_scale(double scale) {
   SCALE = scale;
}

// Function to calibrate the HX711 with a known weight
void hx711_calibrate(float known_weight) {
   // Vi?c tare s? du?c g?i t? main.c tru?c khi g?i hàm này,
   // ho?c hàm này có th? g?i tare n?i b? n?u c?n.
   // Ð? don gi?n và ki?m soát t? main.c, ta s? không g?i tare ? dây.
   // hx711_tare(1); // Không g?i tare ? dây d? ki?m soát t? main.c
   // delay_ms(500); // Ch? ?n d?nh sau khi tare

   if (known_weight <= 0) return; // Tránh chia cho 0 ho?c hi?u chu?n v?i tr?ng lu?ng không h?p l?.

   // Ð?c giá tr? raw sau khi d?t v?t m?u dã bi?t lên load cell
   long raw_value_with_weight = readAverage();
   
   // Tính toán giá tr? raw th?c s? c?a tr?ng lu?ng dã bi?t (sau khi tr? offset)
   long delta_raw = raw_value_with_weight - OFFSET;

   // Tính toán l?i SCALE
   if (delta_raw != 0) {
      SCALE = (double)delta_raw / known_weight;
   }
}

#endif // HX711_H
