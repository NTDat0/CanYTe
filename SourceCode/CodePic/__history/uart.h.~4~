#ifndef UART_H
#define UART_H

#include <16F877A.h>
#include <string.h>

#use rs232(baud=9600, xmit=PIN_C6, rcv=PIN_C7, stream=UART_STREAM)

void uart_init() {
   // UART is initialized by #use rs232 directive
}

void uart_send_string(char *str) {
   while (*str) {
      putc(*str, UART_STREAM);
      str++;
   }
}

void uart_send_data(unsigned int8 temp, unsigned int8 hum, int32 hr_value, int32 spo2_value, int32 weight_grams) {
   char buffer[50];
   int1 has_data = 0;
   
   // Periodic test message
   static int32 test_counter = 0;
   if (test_counter % 50 == 0) { // Send every ~250ms (50 * 5ms)
      sprintf(buffer, "TEST:OK\n");
      uart_send_string(buffer);
   }
   test_counter++;

   // Send non-zero sensor data
   buffer[0] = '\0';
   if (temp != 0) {
      sprintf(buffer, "T:%u ", temp);
      has_data = 1;
   }
   if (hum != 0) {
      sprintf(buffer + strlen(buffer), "H:%u ", hum);
      has_data = 1;
   }
   if (hr_value != 0) {
      sprintf(buffer + strlen(buffer), "HR:%ld ", hr_value);
      has_data = 1;
   }
   if (spo2_value != 0) {
      sprintf(buffer + strlen(buffer), "SPO2:%ld ", spo2_value);
      has_data = 1;
   }
   if (weight_grams != 0) {
      sprintf(buffer + strlen(buffer), "W:%ld", weight_grams);
      has_data = 1;
   }
   
   if (has_data) {
      sprintf(buffer + strlen(buffer), "\n");
      uart_send_string(buffer);
   }
}

#endif
