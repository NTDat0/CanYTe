#ifndef HX711_H
#define HX711_H

#define HX711_DT_PIN PIN_A0
#define HX711_SCK_PIN PIN_A1

long OFFSET = 0;
double SCALE = 377.0;
double SCALE_TABLE[3] = {377.0, 37.7, 3.77}; // <100g, 100g-1kg, >1kg
int8 WEIGHT_RANGE = 0; // 0: <100g, 1: 100g-1kg, 2: >1kg

unsigned int32 readCount(void) {
   unsigned int32 data = 0;
   unsigned int8 j;

   output_bit(HX711_DT_PIN, 1);
   output_bit(HX711_SCK_PIN, 0);

   while (input(HX711_DT_PIN));
   for (j = 0; j < 24; j++) {
      output_bit(HX711_SCK_PIN, 1);
      data = data << 1;
      output_bit(HX711_SCK_PIN, 0);
      if (input(HX711_DT_PIN)) {
         data++;
      }
   }
   output_bit(HX711_SCK_PIN, 1);
   data = data ^ 0x800000;
   output_bit(HX711_SCK_PIN, 0);
   return data;
}

int32 readAverage(void) {
   unsigned int32 sum = 0;
   int8 k;
   for (k = 0; k < 6; k++) {
      sum += readCount();
   }
   return sum / 6;
}

long hx711_get_value(int8 times) {
   long raw_value = readAverage();
   long delta = raw_value - OFFSET;
   long threshold = (WEIGHT_RANGE == 0) ? 150 : (WEIGHT_RANGE == 1) ? 400 : 800;
   if (delta < threshold && delta > -threshold) delta = 0;
   return delta;
}

float hx711_get_units(int8 times) {
   SCALE = SCALE_TABLE[WEIGHT_RANGE];
   long raw_value = readAverage(); // Get raw value
   long delta = raw_value - OFFSET;
   long threshold = (WEIGHT_RANGE == 0) ? 150 : (WEIGHT_RANGE == 1) ? 400 : 800;
   if (delta < threshold && delta > -threshold) delta = 0;
   float value = (float)delta / SCALE;
   if (value < 0) value = 0;
   if (value > 99999 || raw_value > 0x7FFFFF || raw_value < -0x7FFFFF) value = 99999;
   if (value < 100) WEIGHT_RANGE = 0;
   else if (value < 1000) WEIGHT_RANGE = 1;
   else WEIGHT_RANGE = 2;
   return value;
}

void hx711_tare(int8 times) {
   OFFSET = readAverage();
}

void hx711_set_scale(double scale) {
   SCALE = scale;
}

void hx711_manual_tare(void) {
   if (!input(PIN_B0)) {
      delay_ms(50);
      if (!input(PIN_B0)) {
         hx711_tare(10);
         LCD_SetPosition(LINE_4 + 7);
         LCD_PutChar('T'); LCD_PutChar('a'); LCD_PutChar('r');
         delay_ms(500);
      }
   }
}

#endif
