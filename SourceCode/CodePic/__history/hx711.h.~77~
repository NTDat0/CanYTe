#ifndef HX711_H
#define HX711_H

// HX711 Pin Definitions
#define HX711_DT_PIN PIN_A0
#define HX711_SCK_PIN PIN_A1

// ****** C? Ð? CHUY?N Ð?I CH? Ð? THU TH?P D? LI?U THÔ ******
// Ð?t ENABLE_RAW_DATA_COLLECTION thành 1 d? hx711_get_units() tr? v? giá tr? thô t? readAverage().
// Ð?t thành 0 d? hx711_get_units() ho?t d?ng bình thu?ng (tr? v? tr?ng lu?ng dã scale).
#define ENABLE_RAW_DATA_COLLECTION 0 // M?c d?nh là 0 (ch? d? ho?t d?ng bình thu?ng)
// **********************************************************

// Global variables for offset and scale
long OFFSET = 0;
double SCALE = 466.837; // Gi? giá tr? SCALE b?n dang dùng

// Bi?n d? luu giá tr? thô trung bình g?n nh?t (ch? dùng khi ENABLE_RAW_DATA_COLLECTION = 1)
static int32 last_raw_average_value = 0;

// Function to read raw data from HX711
unsigned int32 readCount(void) {
   unsigned int32 data = 0;
   unsigned int8 j;

   output_bit(HX711_DT_PIN, 1);
   output_bit(HX711_SCK_PIN, 0);

   while (input(HX711_DT_PIN));
   for (j = 0; j < 24; j++) {
      output_bit(HX711_SCK_PIN, 1);
      data = data << 1;
      output_bit(HX711_SCK_PIN, 0);
      if (input(HX711_DT_PIN)) {
         data++;
      }
   }
   output_bit(HX711_SCK_PIN, 1);
   data = data ^ 0x800000;
   output_bit(HX711_SCK_PIN, 0);
   return data;
}

// Function to read average raw value
int32 readAverage(void) {
   unsigned int32 sum = 0;
   int8 k;

   for (k = 0; k < 30; k++) {
      sum += readCount();
   }
   last_raw_average_value = sum / 30; // Luu l?i giá tr? thô trung bình
   return last_raw_average_value;
}

// Function to get value (raw - offset)
long hx711_get_value(int8 times) { // times không du?c s? d?ng
   long raw_value = readAverage(); // readAverage() s? c?p nh?t last_raw_average_value
   long delta = raw_value - OFFSET;
   if (delta < 300 && delta > -300) delta = 0;
   return delta;
}

// Function to get weight in grams OR raw average value
float hx711_get_units(int8 times) { // times không du?c s? d?ng
#if ENABLE_RAW_DATA_COLLECTION == 1
    // Ch? d? thu th?p d? li?u thô:
    // G?i hx711_get_value d? nó g?i readAverage() và c?p nh?t last_raw_average_value
    // Chúng ta không quan tâm d?n giá tr? tr? v? c?a hx711_get_value ? dây.
    hx711_get_value(times);
    return (float)last_raw_average_value; // Tr? v? giá tr? thô trung bình g?n nh?t
#else
    // Ch? d? ho?t d?ng bình thu?ng:
    float value = (float)hx711_get_value(times) / SCALE;
    if (value < 0) value = 0;
    if (value > 99999) value = 99999;
    return value;
#endif
}

// Function to tare (set offset)
void hx711_tare(int8 times) { // times không du?c s? d?ng
   OFFSET = readAverage(); // readAverage() s? c?p nh?t last_raw_average_value
}

// Function to set scale factor
void hx711_set_scale(double new_scale) {
   SCALE = new_scale;
}

// Function to calibrate scale with a known weight
void hx711_calibrate(float known_weight) {
   if (known_weight <= 0) return;
   hx711_tare(10); // times không du?c s? d?ng
   long raw_value = readAverage(); // readAverage() s? c?p nh?t last_raw_average_value
   SCALE = (float)(raw_value - OFFSET) / known_weight;
}

#endif
